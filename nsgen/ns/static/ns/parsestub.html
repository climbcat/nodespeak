<!DOCTYPE HTML>
<html>
<body>
<!--<script src="calculator.js"></script>-->
<script src="tpeparser.js"></script>
<script>
class CreateNode {
  constructor(basetype, name, clss=null) {
    this.basetype = basetype;
    this.name = name; // this can include classname, as in MyCls.someMet
    this.args = [];
    this.locked = false;
  }
  addArg(name, tpe=null){
    if (!this.locked) this.args.push([name, tpe]); // this should conform to node engine use
  }
  getNode() {
    this.locked = true;
    // TODO: node conf construction from info held by this class
    console.log("getNode: ", this.basetype, this.name, this.args);
  }
}

// taking "args" nested list (with varname or typename+varname) and a createnode instance
function recurseArgs(res, cn) {
  if (res.length == 1) {
    cn.addArg(name=res[0]);
    return;
  }
  else if (res.length == 2 && !Array.isArray(res[1])) {
    cn.addArg(name=res[1], tpe=res[0]);
    return;
  }
  else if (res.length == 3 && Array.isArray(res[2])) {
    cn.addArg(name=res[1], tpe=res[0]);
    recurseArgs(res[2], cn);
  }
  else if (res.length == 2 && Array.isArray(res[1])) {
    cn.addArg(name=res[0]);
    recurseArgs(res[1], cn);
  }
  else throw "recursArgs: bad format";
}

// TODO: conform to node engine basetype
function createNode(result) {
  let cn = null;
  if (result[0] == "type") {
    cn = new CreateNode(basetype="type", name=result[1][0])
  }
  else if (result[0] == "func") {
    cn = new CreateNode(basetype="func", name=result[1][0]); // or whatever it is ...
    if (result[1].length > 1) recurseArgs(result[1][1], cn);
  }
  else if (result[0] == "method") {
    cn = new CreateNode(basetype="method", name=result[1][0] + '.' + result[1][1][0]); // or whatever it is ...
    if (result[1][1].length > 1) recurseArgs(result[1][1][1], cn);
  }
  else throw "createNode: bad format";
  return cn.getNode();
}

function testclick() {
  // SIMPLE TYPE
  var result = tpeparser.parse("int");
  console.log(result);
  // CAPITALISED
  var result = tpeparser.parse("MyClass");
  console.log(result);
  // SIMPLE FUNCTION
  var result = tpeparser.parse("smple()");
  console.log(result);
  // MULTIPLE ARGS
  var result = tpeparser.parse("f(Abe, kat)");
  console.log(result);
  // TYPED ARGS
  var result = tpeparser.parse("f(int Abe, bool kat)");
  console.log(result);
  // MIXED
  var result = tpeparser.parse("f(int Abe, kat)");
  console.log(result);
  // METHOD - NO ARGS
  var result = tpeparser.parse("clzz.egadd()");
  console.log(result);
  // METHOD
  var result = tpeparser.parse("cls.mymet(en, to, tre)");
  console.log(result);
  // METHOD MIXED
  var result = tpeparser.parse("cls.mymet(double en, string to, tre)");
  console.log(result);
  createNode(result);
}
</script>

<button name="test" type="button" onclick="testclick()">click</input>
</body>
</html>
