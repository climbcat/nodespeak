<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <link rel="stylesheet" href="/static/ns/gui.css">
  <title>NSGEN visual code generation</title>
</head>

<body>
<div id="buttons" style="position:absolute;margin:auto;">
  <a href="/dashboard">home</a>
  <button id="btnUndo">Undo</button>
  <button id="btnRedo">Redo</button>
  <button id="btnLoad">Load</button>
  <button id="btnCommit">Save</button>
  <button id="btnCogen">Cogen</button>
  <a href="/dashboard">logout</a><br>
  <div style="text-align:center;margin-top:5px;">
    <input type="text" id="tbxNodeLabel" size=8>
  </div>
</div>
<div id="status" style="position:absolute;margin:auto;"><label id="lblStatus"></label></div>

<div id="graph_menu_1" style="position:absolute;left:303px;overflow-y:hidden;overflow-x:hidden;margin:auto;margin-bottom:1px;"></div>
<div id="graph_menu_2" style="position:absolute;left:202px;overflow-y:hidden;overflow-x:hidden;margin:auto;margin-bottom:1px;"></div>
<div id="graph_menu_3" style="position:absolute;left:101px;overflow-y:hidden;overflow-x:hidden;margin:auto;margin-bottom:1px;"></div>
<div id="graph_menu_4" style="position:absolute;left:  0px;overflow-y:hidden;overflow-x:hidden;margin:auto;margin-bottom:1px;"></div>

<div id="tpeedt_wrapper" style="position:absolute;overflow-y:hidden;overflow-x:hidden;margin:auto;">
<div id="tpeedt_1"></div>
<div id="tpeedt_2"></div>
</div>
<!-- graph session key, must be sent along with every ajax call -->
<input id="gs_id" type="hidden" value="{{ gs_id }}">
<!-- graph session key, must be sent along with every ajax call -->
<input id="tab_id" type="hidden" value="{{ tab_id }}">
</body>

<script src="/static/ns/d3.v4.min.js"></script>
<script src="/static/ns/jquery.min.js"></script>
<script src="/static/ns/typetreeui.js"></script>
<script src="/static/ns/tpeparser.js"></script>
<script src="/static/ns/graphui.js"></script>
<script src="/static/ns/nodetypes.js"></script>
<script src="/static/ns/nsgen.js"></script>

<script>
let intface = null;
var statusConsole = function(s) {
  let status = d3.select("#status");
  status.html(s);
  status.style("left", window.innerWidth/2-status.node().clientWidth/2 + "px");
}

$(document).ready(() => {
  // button events
  $("#btnUndo").click( () => { intface.undo(); });
  $("#btnRedo").click( () => { intface.redo(); });
  $("#btnLoad").click( () => { intface.loadSession(); });
  $("#btnCommit").click( () => { intface.commitSession(); });
  $("#btnCogen").click( () => { intface.cogenSession(); });

  // key press events for undo/redo
  document.addEventListener('keydown', function(event) {
    if (event.ctrlKey && event.key === 'z') { intface.undo(); }
    else if (event.ctrlKey && event.key === 'y') { intface.redo(); }
    else if (event.ctrlKey && event.shiftKey && event.key === 'Z') { intface.redo(); }
  });

  // construct graph engine and add listeners
  let gs_id = $("body > #gs_id")[0].value;
  let tab_id = $("body > #tab_id")[0].value;
  intface = new GraphInterfaceNSGen(gs_id, tab_id);

  // label textbox
  let tbx = $("#tbxNodeLabel")
  tbx.change( () => { // commit to node label at enter/tab keypress (and focus out)
    intface.pushSelectedNodeLabel(tbx.val());
    tbx.val("");
  });
  tbx.on('keydown', (event) => { // press escape to remove focus
    if (event.key != "Escape") return;
    tbx.prop("selected", false)
    tbx.blur();
  });
  intface.addNodeSelectionListener( (n) => { // set label text and select @ node click
    if (n==null) return;
    tbx.val(n.label);
    tbx.select();
  });

  // set type tree and create node menus (gentypes01 menu structure)
  intface.addSessionLoadListener( (tree) => {
    // setup the menus manually
    let fc_addr = tree["menus"]["FLOWCHART"];
    let fc_confs = fc_addr.map( (itm) => nodeTypeReadTree(itm, tree) );
    let menu4 = new NodeTypeMenu('graph_menu_4', 'flowchart', fc_confs);
    menu4.rgstrClickConf(intface.setCreateNodeConf.bind(intface));
    let dg_addr = tree["menus"]["DATAGRAPH"];
    let dg_confs = dg_addr.map( (itm) => nodeTypeReadTree(itm, tree) );
    let menu3 = new NodeTypeMenu('graph_menu_3', 'datagraph', dg_confs);
    menu3.rgstrClickConf(intface.setCreateNodeConf.bind(intface));

    // type editor
    d3.select("#tpeedt_wrapper")
      .style("background-color", "white")
      .style("padding", "3px")
      .style("border", "1px solid gray");
    let tpeedt_1 = d3.select("#tpeedt_1")
      .style("background-color", "white")
      .style("padding", "3px");
    let tpeedt_2 = d3.select("#tpeedt_2")
      .style("background-color", "white")
      .style("padding", "3px");
    let canDelHook = (addr) => { return !intface.graphData.hasNodeOfAddress(addr) };
    let ttui_1 = new TypeTreeUi("ttui_1", tpeedt_1, tree["menus"]["BUILTIN"], "user.builtin", tree, canDelHook, usetbx=false);
    ttui_1.rgstrClickConf(intface.setCreateNodeConf.bind(intface));
    let ttui_2 = new TypeTreeUi("ttui_2", tpeedt_2, tree["menus"]["CUSTOM"], "user.custom", tree, canDelHook);
    ttui_2.rgstrClickConf(intface.setCreateNodeConf.bind(intface));

    intface.updateUi();
  });

  // universal noselect to prevent selection during node handling. (This does not prevent selection in textboxes etc.)
  $("body").addClass("noselect");

  // position status label below buttons
  let h = $("#buttons").outerHeight();
  let t = $("#buttons").position().top;
  $("#status").css({ "top" : (h+t)+"px", "user-select" : "auto" });

  // load graph and run
  intface.loadSession();
});
</script>
</html>
